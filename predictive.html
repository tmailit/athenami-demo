<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VeriTechIQ – Predictive Strength (Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <!-- Top Nav: match demo folder -->
    <nav class="mb-2 border-b border-slate-800 pb-2">
      <div class="flex flex-wrap items-center gap-2 text-xs">
        <a
          href="./vei_v2_demo.html"
          class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/70 px-3 py-1.5
                 font-medium text-slate-200 hover:border-sky-500/60 hover:text-sky-300 transition"
        >
          <span class="h-1.5 w-1.5 rounded-full bg-slate-400"></span>
          <span>Home · VEI v2</span>
        </a>

        <a
          href="./actions.html"
          class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/70 px-3 py-1.5
                 font-medium text-slate-200 hover:border-sky-500/60 hover:text-sky-300 transition"
        >
          <span class="h-1.5 w-1.5 rounded-full bg-slate-400"></span>
          <span>Action Engine</span>
        </a>

        <a
          href="./clusters.html"
          class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/70 px-3 py-1.5
                 font-medium text-slate-200 hover:border-sky-500/60 hover:text-sky-300 transition"
        >
          <span class="h-1.5 w-1.5 rounded-full bg-slate-400"></span>
          <span>Clusters</span>
        </a>

        <a
          href="./roi_simulation.html"
          class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/70 px-3 py-1.5
                 font-medium text-slate-200 hover:border-sky-500/60 hover:text-sky-300 transition"
        >
          <span class="h-1.5 w-1.5 rounded-full bg-slate-400"></span>
          <span>ROI Simulation</span>
        </a>
      </div>
    </nav>

    <!-- Header with ORG selector -->
    <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="space-y-1">
        <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">
          Predictive Strength – Tier-3 vs Legacy
        </h1>
        <p class="text-sm text-slate-300">
          Demo view of how VeriTechIQ Tier-3 constructs predict outcomes compared to legacy metrics
          (opens/clicks/vanity engagement) after passing the Reliability Verification Gate (Cronbach’s α).
        </p>
      </div>

      <div class="flex flex-col items-stretch gap-2 sm:items-end sm:gap-3">
        <!-- ORG selector -->
        <div class="flex items-center gap-2 justify-end">
          <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Org</span>
          <div
            id="orgSelector"
            class="inline-flex items-center rounded-full border border-slate-700 bg-slate-900/80 p-1 text-xs font-medium shadow-sm"
          >
            <button
              type="button"
              class="org-pill rounded-full px-3 py-1 text-[11px] tracking-wide text-slate-200 hover:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/70 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
              data-org="democo"
            >DemoCo</button>

            <button
              type="button"
              class="org-pill rounded-full px-3 py-1 text-[11px] tracking-wide text-slate-200 hover:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/70 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
              data-org="hubspot"
            >HubSpot</button>

            <button
              type="button"
              class="org-pill rounded-full px-3 py-1 text-[11px] tracking-wide text-slate-200 hover:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/70 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
              data-org="salesforce"
            >Salesforce</button>

            <button
              type="button"
              class="org-pill rounded-full px-3 py-1 text-[11px] tracking-wide text-slate-200 hover:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/70 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
              data-org="all"
            >All orgs</button>
          </div>
        </div>

        <!-- Campaign filter -->
        <div class="flex items-center gap-2 justify-end">
          <input
            id="campaignInput"
            type="text"
            placeholder="All campaigns"
            class="w-40 sm:w-56 rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm
                   placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/70"
          />
          <button
            id="campaignButton"
            class="rounded-xl bg-sky-500 hover:bg-sky-400 active:bg-sky-600 px-4 py-2
                   text-sm font-medium text-slate-950 transition"
          >Apply</button>
        </div>
      </div>
    </header>

    <!-- Top summary row -->
    <section class="grid gap-4 md:grid-cols-3">
      <!-- Tier-3 card -->
      <article class="col-span-1 rounded-2xl border border-emerald-500/40 bg-gradient-to-br from-emerald-500/10 via-slate-950 to-slate-950 p-4 flex flex-col gap-2">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-emerald-300 uppercase tracking-wide">Tier-3 (VeriTechIQ)</h2>
          <span id="tier3BandBadge" class="inline-flex items-center rounded-full bg-slate-800 px-2.5 py-0.5 text-[11px] font-medium uppercase tracking-wide">—</span>
        </div>
        <p class="text-xs text-slate-300">
          Predictive power of Tier-3 constructs (Trust, Clarity, Motivation, ROI-Intent) after reliability gating.
        </p>
        <div class="mt-2 flex items-baseline gap-2">
          <span id="tier3R2" class="text-3xl font-semibold tabular-nums">—</span>
          <span class="text-xs text-slate-400">R² vs business outcome</span>
        </div>
        <p id="tier3N" class="text-xs text-slate-400 mt-1">n = —</p>
        <p id="tier3ReliabilityMeta" class="text-[11px] text-slate-400">
          Reliability: Cronbach’s α — · n = —
        </p>
      </article>

      <!-- Legacy card -->
      <article class="col-span-1 rounded-2xl border border-slate-700 bg-slate-900/60 p-4 flex flex-col gap-2">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-amber-300 uppercase tracking-wide">Legacy Metrics</h2>
          <span id="legacyBandBadge" class="inline-flex items-center rounded-full bg-slate-800 px-2.5 py-0.5 text-[11px] font-medium uppercase tracking-wide">—</span>
        </div>
        <p class="text-xs text-slate-300">
          Predictive power of legacy email metrics (opens, clicks, generic engagement scores).
        </p>
        <div class="mt-2 flex items-baseline gap-2">
          <span id="legacyR2" class="text-3xl font-semibold tabular-nums">—</span>
          <span class="text-xs text-slate-400">R² vs business outcome</span>
        </div>
        <p id="legacyN" class="text-xs text-slate-400 mt-1">n = —</p>
        <p id="legacyNote" class="text-[11px] text-slate-400 mt-2"></p>
      </article>

      <!-- Reliability engine -->
      <article class="col-span-1 rounded-2xl border border-slate-700 bg-slate-900/50 p-4 flex flex-col justify-between gap-3">
        <div class="space-y-2">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-sm font-semibold text-sky-300 uppercase tracking-wide">Reliability Engine</h2>

            <div class="flex flex-col items-end gap-1">
              <span id="reliabilityBandBadge"
                class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-[11px] font-medium uppercase tracking-wide bg-slate-800"
              >—</span>

              <span class="relative group inline-flex">
                <span id="dataIntegrityBadge"
                  class="inline-flex items-center gap-1.5 rounded-full border border-slate-600 bg-slate-900/80 px-2.5 py-0.5 text-[10px] font-medium uppercase tracking-wide text-slate-200"
                >
                  <span id="dataIntegrityDot" class="h-1.5 w-1.5 rounded-full bg-slate-400"></span>
                  <span id="dataIntegrityText">Source: —</span>
                </span>

                <span
                  class="pointer-events-none absolute right-0 top-full mt-1 w-64 rounded-md bg-slate-900 px-3 py-2 text-[10px] font-normal text-slate-100 opacity-0 shadow-lg ring-1 ring-slate-700 transition-opacity group-hover:opacity-100"
                >
                  Data integrity = whether this view is based on verified Tier-3 responses vs. a seeded demo default.
                  Confidence is a simple heuristic using reliability band + sample size + fallback status.
                </span>
              </span>
            </div>
          </div>

          <p id="reliabilityStatus" class="text-xs text-slate-200">Reliability status: assessing Cronbach’s α and sample size…</p>
          <p id="reliabilityMeta" class="text-[11px] text-slate-400">Cronbach’s α: — · Tier-3 n: —</p>

          <ul class="mt-1 text-[11px] text-slate-300 space-y-0.5 list-disc list-inside">
            <li>Cronbach’s α <span class="font-semibold">≥ .70</span> and stable.</li>
            <li>Sample size <span class="font-semibold">n ≥ 100</span> for “Decision-Ready”.</li>
            <li>Otherwise: <span class="text-amber-300 font-semibold">Emerging</span> or <span class="text-slate-300 font-semibold">Learning</span>.</li>
          </ul>
        </div>

        <p class="text-[11px] text-slate-400">
          No shaky stats, no vanity stories. Green is safe for high-stakes decisions; amber/gray fuel controlled experiments.
        </p>
      </article>
    </section>

    <!-- Comparison bars -->
    <section class="space-y-4">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-sm font-semibold tracking-wide text-slate-100">Predictive Strength Comparison (R²)</h2>
        <p id="metaCampaign" class="text-xs text-slate-400">
          Campaign scope: <span class="font-medium text-sky-300">All</span>
        </p>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 space-y-4">
        <div class="flex flex-wrap items-center gap-3 text-[11px] text-slate-300">
          <div class="inline-flex items-center gap-1.5">
            <span class="h-2.5 w-5 rounded-full bg-emerald-500/80"></span><span>Tier-3 R²</span>
          </div>
          <div class="inline-flex items-center gap-1.5">
            <span class="h-2.5 w-5 rounded-full bg-amber-400/90"></span><span>Legacy R²</span>
          </div>
          <span class="text-slate-500">&middot;</span>
          <span>
            Bands:
            <span class="font-medium text-emerald-300">Green ≥ .25</span>,
            <span class="font-medium text-amber-300">Amber .10–.24</span>,
            <span class="font-medium text-rose-300">Red &lt; .10</span>
          </span>
        </div>

        <div class="space-y-3">
          <div>
            <div class="flex items-center justify-between text-xs mb-1.5">
              <span class="font-medium text-slate-100">Tier-3 (VeriTechIQ)</span>
              <span id="tier3R2Label" class="tabular-nums text-slate-300">—</span>
            </div>
            <div class="h-7 w-full rounded-full bg-slate-800/80 overflow-hidden">
              <div id="tier3Bar" class="h-full rounded-full bg-emerald-500/80 transition-[width] duration-500 ease-out" style="width:0%"></div>
            </div>
          </div>

          <div>
            <div class="flex items-center justify-between text-xs mb-1.5">
              <span class="font-medium text-slate-100">Legacy metrics</span>
              <span id="legacyR2Label" class="tabular-nums text-slate-300">—</span>
            </div>
            <div class="h-7 w-full rounded-full bg-slate-800/80 overflow-hidden">
              <div id="legacyBar" class="h-full rounded-full bg-amber-400/90 transition-[width] duration-500 ease-out" style="width:0%"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- KPI Impact Predictor -->
    <section class="mt-6 space-y-2">
      <h2 class="text-sm font-semibold tracking-wide text-slate-100">KPI Impact Predictor</h2>
      <p class="text-[11px] text-slate-400">
        Directional lift window driven by the strongest Tier-3 lever. Becomes decision-grade when Reliability is green.
      </p>

      <div id="kpiPredictorCard" class="mt-3 rounded-2xl border border-slate-800 bg-slate-900/70 p-4 space-y-3">
        <p id="kpiSummary" class="text-[12px] text-slate-300">Loading KPI projections…</p>

        <dl class="grid grid-cols-2 gap-4 text-xs">
          <div><dt class="text-slate-400">Estimated KPI lift range</dt><dd id="kpiLiftRange" class="text-emerald-300">—</dd></div>
          <div><dt class="text-slate-400">Current KPI baseline</dt><dd id="kpiBaseline" class="text-slate-300">—</dd></div>
          <div><dt class="text-slate-400">Driver influence</dt><dd id="kpiDriverStrength" class="text-sky-300">—</dd></div>
          <div><dt class="text-slate-400">High-intent segment shift</dt><dd id="kpiSegmentShift" class="text-slate-300">—</dd></div>
          <div>
            <dt class="text-slate-400">Tier-1 + Tier-3 uplift (directional)</dt>
            <dd id="kpiTierUplift" class="text-slate-300">—</dd>
          </div>
        </dl>

        <button id="kpiRunSimulation" type="button"
          class="mt-3 rounded-xl bg-sky-500 hover:bg-sky-400 active:bg-sky-600 px-4 py-2 text-xs font-medium text-slate-950 transition"
        >
          Run Simulation with this driver →
        </button>
      </div>
    </section>

    <!-- Detail table -->
    <section class="space-y-3">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-sm font-semibold tracking-wide text-slate-100">Construct & Metric Details</h2>
        <p id="lastUpdated" class="text-xs text-slate-400">Last updated: —</p>
      </div>

      <div class="overflow-hidden rounded-2xl border border-slate-800 bg-slate-900/60">
        <div class="overflow-x-auto">
          <table class="min-w-full text-xs">
            <thead class="bg-slate-900/80 text-slate-300">
              <tr class="border-b border-slate-800/80">
                <th class="px-3 py-2 text-left font-medium">Construct / Metric</th>
                <th class="px-3 py-2 text-left font-medium">Source</th>
                <th class="px-3 py-2 text-right font-medium">R²</th>
                <th class="px-3 py-2 text-right font-medium">Decision Band</th>
                <th class="px-3 py-2 text-right font-medium">n</th>
              </tr>
            </thead>
            <tbody id="detailsBody" class="divide-y divide-slate-800/80">
              <tr><td colspan="5" class="px-3 py-4 text-center text-slate-400">Loading predictive metrics…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <p class="text-[11px] text-slate-400">
        Interpretation:
        <span class="font-semibold text-emerald-300">Green</span> = strong predictive link to ROI;
        <span class="font-semibold text-amber-300">Amber</span> = emerging but usable signal;
        <span class="font-semibold text-rose-300">Red</span> = weak/unstable.
      </p>
    </section>
  </div>

  <!-- ✅ THE BIBLE -->
  <script src="./static/demo_data.js"></script>

  <script>
    (function () {
      // ─────────────────────────────────────────────────────────────
      // Query params
      // ─────────────────────────────────────────────────────────────
      const params = new URLSearchParams(window.location.search || "");
      const qpOrg = (params.get("org") || "democo").toLowerCase();
      const qpCampaign = (params.get("campaign") || "All").trim();

      function nowStamp() {
        return new Date().toLocaleString(undefined, { dateStyle: "medium", timeStyle: "short" });
      }

      // ─────────────────────────────────────────────────────────────
      // Bible + legacy fallback (until legacy is added to bible)
      // ─────────────────────────────────────────────────────────────
      const BIBLE = (window.DEMO_ACTIONS_DATA || {});
      const LEGACY_FALLBACK = {
        democo:   { r2: 0.09, n: 310, note: "Legacy is directional and typically noisier than Tier-3 at this stage." },
        hubspot:  { r2: 0.07, n: 260, note: "Legacy metrics are present but typically underpowered early on." },
        salesforce:{ r2: 0.05, n: 240, note: "Learning mode: treat all relationships as directional until Tier-3 volume grows." },
        all:      { r2: 0.08, n: 810, note: "Aggregate demo scope: legacy is broad but not strongly predictive." }
      };

      // ─────────────────────────────────────────────────────────────
      // DOM
      // ─────────────────────────────────────────────────────────────
      const orgPills = document.querySelectorAll(".org-pill");
      const campaignInput = document.getElementById("campaignInput");
      const campaignButton = document.getElementById("campaignButton");

      const tier3R2El = document.getElementById("tier3R2");
      const tier3NEl = document.getElementById("tier3N");
      const tier3BarEl = document.getElementById("tier3Bar");
      const tier3R2LabelEl = document.getElementById("tier3R2Label");
      const tier3BandBadge = document.getElementById("tier3BandBadge");
      const tier3ReliabilityMetaEl = document.getElementById("tier3ReliabilityMeta");

      const legacyR2El = document.getElementById("legacyR2");
      const legacyNEl = document.getElementById("legacyN");
      const legacyBarEl = document.getElementById("legacyBar");
      const legacyR2LabelEl = document.getElementById("legacyR2Label");
      const legacyBandBadge = document.getElementById("legacyBandBadge");
      const legacyNoteEl = document.getElementById("legacyNote");

      const metaCampaignEl = document.getElementById("metaCampaign");
      const lastUpdatedEl = document.getElementById("lastUpdated");
      const detailsBody = document.getElementById("detailsBody");

      const reliabilityBandBadge = document.getElementById("reliabilityBandBadge");
      const reliabilityStatusEl = document.getElementById("reliabilityStatus");
      const reliabilityMetaEl = document.getElementById("reliabilityMeta");

      const dataIntegrityDot = document.getElementById("dataIntegrityDot");
      const dataIntegrityText = document.getElementById("dataIntegrityText");

      const kpiSummaryEl = document.getElementById("kpiSummary");
      const kpiLiftRangeEl = document.getElementById("kpiLiftRange");
      const kpiBaselineEl = document.getElementById("kpiBaseline");
      const kpiDriverStrengthEl = document.getElementById("kpiDriverStrength");
      const kpiSegmentShiftEl = document.getElementById("kpiSegmentShift");
      const kpiTierUpliftEl = document.getElementById("kpiTierUplift");
      const kpiRunSimBtn = document.getElementById("kpiRunSimulation");

      // ─────────────────────────────────────────────────────────────
      // State
      // ─────────────────────────────────────────────────────────────
      let activeOrg = (BIBLE[qpOrg] ? qpOrg : "democo");
      let activeCampaign = qpCampaign || "All";
      let currentDriver = null;
      let currentKpi = "click_rate";

      // ─────────────────────────────────────────────────────────────
      // Helpers
      // ─────────────────────────────────────────────────────────────
      function formatR2(value) {
        if (value == null || isNaN(value)) return "—";
        return value.toFixed(3).replace(/^0+/, "");
      }
      function formatInt(value) {
        if (value == null || isNaN(value)) return "—";
        return Number(value).toLocaleString();
      }
      function pct(value) {
        if (value == null || !isFinite(value)) return "—";
        return (value * 100).toFixed(1) + "%";
      }

      const bandColors = {
        green: { bg: "bg-emerald-500/20 border border-emerald-400/70 text-emerald-200", dot: "bg-emerald-400" },
        amber: { bg: "bg-amber-500/20 border border-amber-400/80 text-amber-200", dot: "bg-amber-400" },
        yellow:{ bg: "bg-amber-500/20 border border-amber-400/80 text-amber-200", dot: "bg-amber-400" }, // legacy
        red:   { bg: "bg-rose-500/20 border border-rose-400/80 text-rose-200", dot: "bg-rose-400" },
        gray:  { bg: "bg-slate-700/40 border border-slate-500/80 text-slate-200", dot: "bg-slate-300" }
      };

      function bandForR2(r2) {
        if (r2 == null || isNaN(r2)) return "gray";
        if (r2 >= 0.25) return "green";
        if (r2 >= 0.10) return "amber";
        return "red";
      }

      function describeBand(band) {
        if (band === "green") return "Decision-Ready";
        if (band === "amber" || band === "yellow") return "Emerging Signal";
        if (band === "red") return "Weak / Directional Only";
        if (band === "gray") return "Learning";
        return "Unknown";
      }

      function applyBandBadge(el, band, label) {
        const key = band === "yellow" ? "amber" : band;
        const b = bandColors[key] || bandColors.gray;
        el.className = "inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-[11px] font-medium uppercase tracking-wide " + b.bg;
        el.innerHTML = '<span class="h-2 w-2 rounded-full ' + b.dot + '"></span><span>' + label + "</span>";
      }

      function setOrgPillsUI() {
        orgPills.forEach(function (pill) {
          pill.classList.remove("org-pill-active","bg-emerald-500","text-slate-950","shadow-sm","shadow-emerald-500/40");
          pill.classList.add("text-slate-200");
          if ((pill.dataset.org || "democo") === activeOrg) {
            pill.classList.add("org-pill-active","bg-emerald-500","text-slate-950","shadow-sm","shadow-emerald-500/40");
            pill.classList.remove("text-slate-200");
          }
        });
      }

      function updateBars(tier3R2, legacyR2) {
        const t = !isNaN(tier3R2) && tier3R2 != null ? tier3R2 : 0;
        const l = !isNaN(legacyR2) && legacyR2 != null ? legacyR2 : 0;
        tier3BarEl.style.width = Math.max(0, Math.min(100, t * 100)) + "%";
        legacyBarEl.style.width = Math.max(0, Math.min(100, l * 100)) + "%";
      }

      function updateMetaCampaign(label) {
        metaCampaignEl.innerHTML = 'Campaign scope: <span class="font-medium text-sky-300">' + (label || "All") + "</span>";
      }

      function updateLastUpdated(ts) {
        lastUpdatedEl.textContent = "Last updated: " + (ts || "—");
      }

      function updateDataIntegrityBadge(relBand, total, fallbackUsed) {
        const band = (relBand === "yellow") ? "amber" : (relBand || "gray");
        let base = band === "green" ? 0.9 : band === "amber" ? 0.7 : 0.5;
        if (total >= 400) base += 0.05;
        else if (total < 50) base -= 0.15;
        if (fallbackUsed) base = Math.min(base, 0.4);

        const confidence = Math.max(0.1, Math.min(0.99, base));
        const pctConf = Math.round(confidence * 100);

        const sourceLabel = fallbackUsed ? "Synthetic / Theory Seed" : "Verified Tier-3";
        dataIntegrityText.textContent = sourceLabel + " · " + pctConf + "% confidence";

        if (confidence >= 0.8) dataIntegrityDot.className = "h-1.5 w-1.5 rounded-full bg-emerald-400";
        else if (confidence >= 0.6) dataIntegrityDot.className = "h-1.5 w-1.5 rounded-full bg-amber-300";
        else dataIntegrityDot.className = "h-1.5 w-1.5 rounded-full bg-slate-400";
      }

      function setQueryParamSilently(key, value) {
        const p = new URLSearchParams(window.location.search || "");
        if (value == null || value === "") p.delete(key);
        else p.set(key, value);
        const newUrl = window.location.pathname + "?" + p.toString();
        window.history.replaceState({}, "", newUrl);
      }

      function renderDetails(rows) {
        if (!Array.isArray(rows) || rows.length === 0) {
          detailsBody.innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-center text-slate-400">No construct-level predictive data available yet.</td></tr>';
          return;
        }

        detailsBody.innerHTML = rows.map(function (row) {
          const r2 = typeof row.r2 === "number" ? row.r2 : null;
          const n = row.n != null ? row.n : null;
          const band = bandForR2(r2);
          const b = bandColors[band] || bandColors.gray;
          const bandLabel = band === "green" ? "Strong" : band === "amber" ? "Emerging" : band === "red" ? "Weak" : "Unknown";

          return (
            "<tr>" +
              '<td class="px-3 py-2 text-slate-100">' + (row.name || "—") + "</td>" +
              '<td class="px-3 py-2 text-slate-300">' + (row.source || "—") + "</td>" +
              '<td class="px-3 py-2 text-right text-slate-100 tabular-nums">' + formatR2(r2) + "</td>" +
              '<td class="px-3 py-2 text-right">' +
                '<span class="inline-flex items-center gap-1.5 rounded-full px-2 py-0.5 text-[11px] ' + b.bg + ' border text-slate-100">' +
                  '<span class="h-2 w-2 rounded-full ' + b.dot + '"></span>' + bandLabel +
                "</span>" +
              "</td>" +
              '<td class="px-3 py-2 text-right text-slate-300 tabular-nums">' + formatInt(n) + "</td>" +
            "</tr>"
          );
        }).join("");
      }

      function computeLiftFromDriverScore(driverScore, band, fallbackUsed) {
        const s = Math.max(0, Math.min(1, driverScore || 0));
        let base = 0.03 + 0.20 * s;

        const b = (band === "yellow") ? "amber" : band;
        if (b === "amber") base *= 0.7;
        if (b === "gray") base *= 0.4;
        if (fallbackUsed) base *= 0.6;

        const conservative = Math.max(0.005, base * 0.5);
        const stretch = Math.min(0.60, base * 1.8);

        return { conservative, stretch, segShift: 0.10 * s, tierUplift: 0.15 * s };
      }

      // ─────────────────────────────────────────────────────────────
      // Bible adapters
      // ─────────────────────────────────────────────────────────────
      function getOrgData(orgKey) {
        return (BIBLE && BIBLE[orgKey]) ? BIBLE[orgKey] : (BIBLE.democo || null);
      }

      function tier3SummaryFromDrivers(drivers) {
        const ds = Array.isArray(drivers) ? drivers.slice() : [];
        if (!ds.length) return { r2: null, n: null, top: null, details: [] };

        // Keep only Tier-3 constructs (ignore other entries if any)
        const keep = ds.filter(d => !!d && typeof d.r2 === "number");
        keep.sort((a,b) => (b.r2 || 0) - (a.r2 || 0));

        const top = keep[0] || null;

        const details = keep.map(d => ({
          name: d.name || "Tier-3 Construct",
          source: "Tier-3",
          r2: typeof d.r2 === "number" ? d.r2 : null,
          n: d.n != null ? d.n : null
        }));

        return {
          r2: top && typeof top.r2 === "number" ? top.r2 : null,
          n: top && top.n != null ? top.n : null,
          top,
          details
        };
      }

      // ─────────────────────────────────────────────────────────────
      // Render
      // ─────────────────────────────────────────────────────────────
      function render() {
        const data = getOrgData(activeOrg);
        if (!data) return;

        const campaignLabel = (activeCampaign && activeCampaign.trim()) ? activeCampaign.trim() : "All";
        updateMetaCampaign(campaignLabel);

        const decision = data.decision || {};
        const relBandRaw = String(decision.band || "gray").toLowerCase();
        const relBand = (relBandRaw === "yellow") ? "amber" : relBandRaw;

        const alpha = (typeof decision.alpha === "number") ? decision.alpha : null;
        const tier3_n = (typeof decision.n === "number") ? decision.n : null;
        const status = decision.status || describeBand(relBand);

        applyBandBadge(reliabilityBandBadge, relBand, status);
        reliabilityStatusEl.textContent = "Reliability status: " + status;
        reliabilityMetaEl.textContent = "Cronbach’s α: " + (alpha != null ? alpha.toFixed(2) : "—") + " · Tier-3 n: " + formatInt(tier3_n);

        // Tier-3 from bible drivers
        const drivers = Array.isArray(data.drivers) ? data.drivers : [];
        const tier3 = tier3SummaryFromDrivers(drivers);

        applyBandBadge(tier3BandBadge, relBand, describeBand(relBand));
        tier3R2El.textContent = formatR2(tier3.r2);
        tier3R2LabelEl.textContent = formatR2(tier3.r2);
        tier3NEl.textContent = "n = " + formatInt(tier3_n);
        tier3ReliabilityMetaEl.textContent =
          "Reliability: Cronbach’s α " +
          (alpha != null ? alpha.toFixed(2) : "—") +
          " · n = " + formatInt(tier3_n);

        // Legacy fallback (until bible includes it)
        const legacy = LEGACY_FALLBACK[activeOrg] || LEGACY_FALLBACK.democo;
        const legacyBand = bandForR2(legacy.r2);

        applyBandBadge(legacyBandBadge, legacyBand, describeBand(legacyBand));
        legacyR2El.textContent = formatR2(legacy.r2);
        legacyR2LabelEl.textContent = formatR2(legacy.r2);
        legacyNEl.textContent = "n = " + formatInt(legacy.n);
        legacyNoteEl.textContent = legacy.note || "";

        // Bars
        updateBars(tier3.r2, legacy.r2);

        // Details table (Tier-3 drivers + a couple legacy lines)
        const detailRows = []
          .concat(tier3.details)
          .concat([
            { name: "Click rate", source: "Legacy", r2: legacy.r2, n: legacy.n },
            { name: "Open rate", source: "Legacy", r2: Math.max(0, (legacy.r2 || 0) - 0.03), n: legacy.n }
          ]);

        renderDetails(detailRows);

        updateLastUpdated(nowStamp());

        // Data integrity badge
        const fallbackUsed = (relBand === "gray"); // simple demo rule: gray = learning
        updateDataIntegrityBadge(relBand, tier3_n || 0, fallbackUsed);

        // KPI predictor: use top driver r2 as influence proxy
        const top = tier3.top;
        if (!top || typeof top.r2 !== "number") {
          kpiSummaryEl.textContent = "VeriTechIQ needs more Tier-3 signal before estimating KPI impact for this scope.";
          kpiLiftRangeEl.textContent = "—";
          kpiBaselineEl.textContent = "Primary KPI (last 30 days)";
          kpiDriverStrengthEl.textContent = "—";
          kpiSegmentShiftEl.textContent = "—";
          kpiTierUpliftEl.textContent = "—";
          kpiRunSimBtn.disabled = true;
          kpiRunSimBtn.classList.add("opacity-50","cursor-not-allowed");
          kpiRunSimBtn.onclick = null;
          currentDriver = null;
        } else {
          currentDriver = top.name || "Key Driver";

          // driver_score proxy: scale r2 into 0..1 (cap at .35 as "high" for demo)
          const driverScore = Math.max(0, Math.min(1, (top.r2 || 0) / 0.35));
          const lift = computeLiftFromDriverScore(driverScore, relBand, fallbackUsed);

          kpiLiftRangeEl.textContent = pct(lift.conservative) + " – " + pct(lift.stretch);
          kpiBaselineEl.textContent = "Primary KPI (last 30 days)";
          kpiDriverStrengthEl.textContent = "R² ≈ " + (top.r2 != null ? top.r2.toFixed(2) : "—") + " · n ≈ " + formatInt(top.n);
          kpiSegmentShiftEl.textContent = "+" + pct(lift.segShift);
          kpiTierUpliftEl.textContent = "+" + pct(lift.tierUplift);

          const reliabilityNote =
            (relBand === "green")
              ? "Reliability is green — this window can inform KPI planning."
              : (relBand === "amber")
                ? "Reliability is emerging — treat as directional while collecting more Tier-3."
                : "Reliability is learning — treat as exploratory only until Tier-3 volume grows.";

          kpiSummaryEl.textContent =
            "For " + (campaignLabel || "this scope") + ", VeriTechIQ identifies " + currentDriver +
            " as the strongest Tier-3 predictor in this dataset. If you improve this driver meaningfully, VeriTechIQ estimates a " +
            pct(lift.conservative) + "–" + pct(lift.stretch) + " lift window across the primary KPI. " + reliabilityNote;

          kpiRunSimBtn.disabled = false;
          kpiRunSimBtn.classList.remove("opacity-50","cursor-not-allowed");
          kpiRunSimBtn.onclick = function () {
            const q = new URLSearchParams();
            q.set("org", activeOrg);
            q.set("driver", currentDriver);
            q.set("kpi", currentKpi);
            if (campaignLabel && campaignLabel.toLowerCase() !== "all") q.set("campaign", campaignLabel);
            window.open("./roi_simulation.html?" + q.toString(), "_blank");
          };
        }

        // Keep URL in sync
        setQueryParamSilently("org", activeOrg);
        setQueryParamSilently("campaign", activeCampaign || "All");
      }

      // ─────────────────────────────────────────────────────────────
      // Events
      // ─────────────────────────────────────────────────────────────
      orgPills.forEach(function (pill) {
        pill.addEventListener("click", function () {
          activeOrg = pill.dataset.org || "democo";
          setOrgPillsUI();
          render();
        });
      });

      campaignButton.addEventListener("click", function () {
        activeCampaign = (campaignInput.value || "").trim() || "All";
        render();
      });

      campaignInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          activeCampaign = (campaignInput.value || "").trim() || "All";
          render();
        }
      });

      // Init
      campaignInput.value = qpCampaign || "All";
      setOrgPillsUI();
      render();
    })();
  </script>

  <!-- Notes / footer -->
  <div class="mt-16 pt-8 border-t border-slate-800 text-[11px] leading-relaxed text-slate-400 max-w-5xl mx-auto px-4 pb-10">
    <p class="font-semibold text-slate-200 mb-2">
      VeriTechIQ Verified Engagement Intelligence — Demo Notes
    </p>
    <p class="mt-2">
      This demo page renders from a local dataset (no live API calls) to ensure stability during investor review.
      In production, predictive metrics are computed from verified engagement events + Tier-3 responses with reliability gating.
    </p>

    <div class="w-full flex flex-col items-center mt-8 pt-6 border-t border-slate-800">
      <p class="text-[10px] tracking-wide uppercase font-semibold text-slate-300">
        VeriTechIQ™ Verified Engagement Intelligence
      </p>
      <p class="text-[10px] text-slate-500 mt-1">
        © 2025 VeriTechIQ. All rights reserved.
      </p>
    </div>
  </div>
</body>
</html>
