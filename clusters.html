<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VeriTechIQ – Psychographic Segments (Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <!-- Top Nav: match demo folder -->
    <nav class="mb-2 border-b border-slate-800 pb-2">
      <div class="flex flex-wrap items-center gap-2 text-xs">
        <a
          href="./vei_v2_demo.html"
          class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/70 px-3 py-1.5
                 font-medium text-slate-200 hover:border-sky-500/60 hover:text-sky-300 transition"
        >
          <span class="h-1.5 w-1.5 rounded-full bg-slate-400"></span>
          <span>Home · VEI v2</span>
        </a>

        <a
          href="./predictive.html"
          class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/70 px-3 py-1.5
                 font-medium text-slate-200 hover:border-sky-500/60 hover:text-sky-300 transition"
        >
          <span class="h-1.5 w-1.5 rounded-full bg-slate-400"></span>
          <span>Predictive Strength</span>
        </a>

        <a
          href="./actions.html"
          class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/70 px-3 py-1.5
                 font-medium text-slate-200 hover:border-sky-500/60 hover:text-sky-300 transition"
        >
          <span class="h-1.5 w-1.5 rounded-full bg-slate-400"></span>
          <span>Action Engine</span>
        </a>

        <span
          class="inline-flex items-center gap-1 rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1.5
                 font-medium text-emerald-200"
        >
          <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
          <span>Clusters</span>
        </span>

        <a
          href="./roi_simulation.html"
          class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/70 px-3 py-1.5
                 font-medium text-slate-200 hover:border-sky-500/60 hover:text-sky-300 transition"
        >
          <span class="h-1.5 w-1.5 rounded-full bg-slate-400"></span>
          <span>ROI Simulation</span>
        </a>
      </div>
    </nav>

    <!-- Header with ORG selector -->
    <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="space-y-1">
        <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">
          Psychographic Segments
        </h1>
        <p class="text-sm text-slate-300">
          Tier-3 segments (Trust, Clarity, Motivation, ROI-Intent) that explain <span class="text-slate-100 font-medium">why</span> people respond — not just whether they clicked.
        </p>

        <p id="scopeLine" class="text-[11px] text-slate-400">
          Scope: <span id="scopeOrg" class="font-semibold text-sky-300">—</span>
          <span class="text-slate-600">·</span>
          Campaign: <span id="scopeCampaign" class="font-semibold text-slate-200">—</span>
        </p>
      </div>

      <div class="flex flex-col items-stretch gap-2 sm:items-end sm:gap-3">
        <!-- ORG selector -->
        <div class="flex items-center gap-2 justify-end">
          <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Org</span>
          <div
            id="orgSelector"
            class="inline-flex items-center rounded-full border border-slate-700 bg-slate-900/80 p-1 text-xs font-medium shadow-sm"
          >
            <button
              type="button"
              class="org-pill rounded-full px-3 py-1 text-[11px] tracking-wide text-slate-200 hover:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/70 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
              data-org="democo"
            >DemoCo</button>

            <button
              type="button"
              class="org-pill rounded-full px-3 py-1 text-[11px] tracking-wide text-slate-200 hover:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/70 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
              data-org="hubspot"
            >HubSpot</button>

            <button
              type="button"
              class="org-pill rounded-full px-3 py-1 text-[11px] tracking-wide text-slate-200 hover:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/70 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
              data-org="salesforce"
            >Salesforce</button>

            <button
              type="button"
              class="org-pill rounded-full px-3 py-1 text-[11px] tracking-wide text-slate-200 hover:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/70 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
              data-org="all"
            >All orgs</button>
          </div>
        </div>

        <!-- Campaign filter -->
        <div class="flex items-center gap-2 justify-end">
          <input
            id="campaignInput"
            type="text"
            placeholder="vip"
            class="w-40 sm:w-56 rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm
                   placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/70"
          />
          <button
            id="campaignButton"
            class="rounded-xl bg-sky-500 hover:bg-sky-400 active:bg-sky-600 px-4 py-2
                   text-sm font-medium text-slate-950 transition"
          >Apply</button>
        </div>
      </div>
    </header>

    <!-- Reliability banner -->
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div class="space-y-1">
          <div class="flex items-center gap-2">
            <span class="text-sm font-semibold tracking-wide text-slate-100">Decision Readiness</span>
            <span id="reliabilityBadge"
              class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-[11px] font-medium uppercase tracking-wide bg-slate-800"
            >—</span>
          </div>
          <p id="reliabilityBody" class="text-xs text-slate-300">
            —
          </p>
          <p id="reliabilityMeta" class="text-[11px] text-slate-400">Cronbach’s α: — · Tier-3 n: —</p>
        </div>

        <div class="flex flex-wrap gap-2 text-[11px] text-slate-400">
          <span class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-950/40 px-3 py-1">
            <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
            Green: α ≥ .70 and n ≥ 100
          </span>
          <span class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-950/40 px-3 py-1">
            <span class="h-1.5 w-1.5 rounded-full bg-amber-300"></span>
            Emerging: close, still stabilizing
          </span>
          <span class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-950/40 px-3 py-1">
            <span class="h-1.5 w-1.5 rounded-full bg-slate-400"></span>
            Learning: exploratory only
          </span>
        </div>
      </div>
    </section>

    <!-- Main grid -->
    <section class="grid gap-4 lg:grid-cols-3">
      <!-- Segments -->
      <div class="lg:col-span-2 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-semibold tracking-wide text-slate-100">Segments</h2>
          <p id="nRespondents" class="text-xs text-slate-400">— respondents</p>
        </div>

        <div id="segmentsWrap" class="space-y-3">
          <!-- injected -->
        </div>
      </div>

      <!-- Distributions + notes -->
      <aside class="space-y-4">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
          <h2 class="text-sm font-semibold tracking-wide text-slate-100">Construct Distributions</h2>
          <p class="mt-1 text-[11px] text-slate-400">
            Shows how responses are distributed across each construct, and how strongly segments differ from one another.

          </p>

          <div id="distGrid" class="mt-4 grid grid-cols-1 gap-3">
            <!-- injected -->
          </div>

          <p class="mt-4 text-[11px] text-slate-400">
            Scale: 1–7 Likert. Interpret alongside Decision Readiness when prioritizing experiments.

          </p>
        </div>

        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
          <h2 class="text-sm font-semibold tracking-wide text-slate-100">How to use this</h2>
          <ul class="mt-2 space-y-1.5 text-[12px] text-slate-300 list-disc list-inside">
            <li>Pick one segment, run one change, measure lift.</li>
            <li>Segments guide <span class="text-slate-100 font-medium">message design</span>, not just targeting.</li>
            <li>When “Emerging,” use as hypothesis fuel. When green, use as planning input.</li>
          </ul>
        </div>
      </aside>
    </section>

    <!-- Footer -->
    <div class="pt-10 border-t border-slate-800 text-[11px] leading-relaxed text-slate-400">
      <p class="font-semibold text-slate-200 mb-2">
        VeriTechIQ Verified Engagement Intelligence — Demo Notes
      </p>
      <p>
        This clusters page is a static demo dataset (no live API calls) to ensure stability during investor review.
        In production, clusters are computed from verified Tier-3 responses with reliability gating and minimum segment-size rules.
      </p>

      <div class="w-full flex flex-col items-center mt-8 pt-6 border-t border-slate-800">
        <p class="text-[10px] tracking-wide uppercase font-semibold text-slate-300">
          VeriTechIQ™ Verified Engagement Intelligence
        </p>
        <p class="text-[10px] text-slate-500 mt-1">
          © 2025 VeriTechIQ. All rights reserved.
        </p>
      </div>
    </div>
  </div>

  <!-- ✅ THE BIBLE -->
  <script src="./static/demo_data.js"></script>

  <script>
    (function () {
      // ─────────────────────────────────────────────────────────────
      // Query params
      // ─────────────────────────────────────────────────────────────
      const params = new URLSearchParams(window.location.search || "");
      const qpOrg = (params.get("org") || "democo").toLowerCase();
      const qpCampaign = (params.get("campaign") || "vip").trim();

      // ─────────────────────────────────────────────────────────────
      // DOM
      // ─────────────────────────────────────────────────────────────
      const orgPills = document.querySelectorAll(".org-pill");
      const campaignInput = document.getElementById("campaignInput");
      const campaignButton = document.getElementById("campaignButton");

      const scopeOrg = document.getElementById("scopeOrg");
      const scopeCampaign = document.getElementById("scopeCampaign");

      const reliabilityBadge = document.getElementById("reliabilityBadge");
      const reliabilityBody = document.getElementById("reliabilityBody");
      const reliabilityMeta = document.getElementById("reliabilityMeta");

      const nRespondents = document.getElementById("nRespondents");
      const segmentsWrap = document.getElementById("segmentsWrap");
      const distGrid = document.getElementById("distGrid");

      // ─────────────────────────────────────────────────────────────
      // State
      // ─────────────────────────────────────────────────────────────
      const BIBLE = (window.DEMO_ACTIONS_DATA || {});
      let activeOrg = (BIBLE[qpOrg] ? qpOrg : "democo");
      let activeCampaign = qpCampaign || "vip";

      // ─────────────────────────────────────────────────────────────
      // Helpers
      // ─────────────────────────────────────────────────────────────
      const bandColors = {
        green: { badge: "bg-emerald-500/20 border border-emerald-400/70 text-emerald-200", dot: "bg-emerald-400", label: "Decision-Ready" },
        amber: { badge: "bg-amber-500/20 border border-amber-400/80 text-amber-200", dot: "bg-amber-300", label: "Emerging" },
        yellow:{ badge: "bg-amber-500/20 border border-amber-400/80 text-amber-200", dot: "bg-amber-300", label: "Emerging" }, // legacy -> amber
        red:   { badge: "bg-rose-500/20 border border-rose-400/80 text-rose-200", dot: "bg-rose-400", label: "Weak" },
        gray:  { badge: "bg-slate-700/40 border border-slate-500/80 text-slate-200", dot: "bg-slate-400", label: "Learning" }
      };

      function clamp(x, lo, hi) { return Math.max(lo, Math.min(hi, x)); }
      function fmtPct(x) {
        const n = Number(x);
        if (!isFinite(n)) return "—";
        return (n * 100).toFixed(0) + "%";
      }
      function fmt1(x) {
        const n = Number(x);
        if (!isFinite(n)) return "—";
        return n.toFixed(1);
      }
      function fmt2(x) {
        const n = Number(x);
        if (!isFinite(n)) return "—";
        return n.toFixed(2);
      }
      function escapeHtml(str) {
        return String(str == null ? "" : str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function applyOrgPillsUI() {
        orgPills.forEach(function (pill) {
          pill.classList.remove("bg-emerald-500","text-slate-950","shadow-sm","shadow-emerald-500/40");
          pill.classList.add("text-slate-200");
          if ((pill.dataset.org || "democo") === activeOrg) {
            pill.classList.add("bg-emerald-500","text-slate-950","shadow-sm","shadow-emerald-500/40");
            pill.classList.remove("text-slate-200");
          }
        });
      }

      function setQueryParamSilently(key, value) {
        const p = new URLSearchParams(window.location.search || "");
        if (value == null || value === "") p.delete(key);
        else p.set(key, value);
        const newUrl = window.location.pathname + "?" + p.toString();
        window.history.replaceState({}, "", newUrl);
      }

      // ─────────────────────────────────────────────────────────────
      // Copy/derive from bible
      // ─────────────────────────────────────────────────────────────
      function getOrgData(orgKey) {
        return (BIBLE && BIBLE[orgKey]) ? BIBLE[orgKey] : (BIBLE.democo || null);
      }

      function deriveDistributions(constructs) {
        // Use mean from bible, synthesize min/max as plausible spread (demo-only, consistent)
        // mean ± 1.7 (clamped to 1..7)
        const out = {};
        (constructs || []).forEach(c => {
          const label = String(c.label || "").toLowerCase();
          const mean = (typeof c.mean === "number") ? c.mean : null;
          if (mean == null) return;
          const min = clamp(mean - 1.7, 1.0, 7.0);
          const max = clamp(mean + 1.7, 1.0, 7.0);
          out[label] = { mean, min, max };
        });
        return {
          trust: out.trust || null,
          clarity: out.clarity || null,
          motivation: out.motivation || null,
          roi_intent: out["roi intent"] || out.roi || out.roi_intent || null
        };
      }

      // Segment action “library” (keeps it feeling real, while names/shares come from bible)
      function actionPackForLabel(label) {
        const key = String(label || "").toLowerCase();

        if (key.includes("motivated value seekers") || key.includes("value seekers")) {
          return [
            "Lead with a concrete outcome (before/after, benchmark, or specific result).",
            "Make the CTA path short and unambiguous (one ask, one next step).",
            "Use urgency carefully (time-boxing that feels real, not gimmicky)."
          ];
        }
        if (key.includes("analytical skeptics") || key.includes("skeptics")) {
          return [
            "Move proof earlier (logos, quantified outcomes, or credible third-party signal).",
            "Add a 3-bullet “How it works” + what happens next (reduce ambiguity).",
            "Add risk reversal (pilot, guarantee, clear exit) near CTA."
          ];
        }
        if (key.includes("confused but curious")) {
          return [
            "Tighten to one promise + one ask (remove competing links).",
            "Add a 2-step “how it works” (Step 1 / Step 2 + timeline).",
            "Use a single proof strip above CTA (reduce perceived risk)."
          ];
        }
        if (key.includes("early-but-skeptical")) {
          return [
            "Add explicit reassurance + next steps (what happens after the click).",
            "Use comparison framing (why this vs their default approach).",
            "Keep collecting Tier-3; treat as directional until readiness improves."
          ];
        }

        // Default
        return [
          "Run one controlled change for this segment and measure lift.",
          "Use clarity + proof sequencing to reduce friction.",
          "Collect more Tier-3 to sharpen boundaries and tighten lift bands."
        ];
      }

      function deriveSegmentsFromBible(orgKey, decisionN, constructs, bibleSegments) {
        // Use bible segment labels + shares as the source of truth.
        // Enforce Salesforce rule: collapse to 1 segment regardless of bible.
        const meanBy = {};
        (constructs || []).forEach(c => { meanBy[String(c.label || "").toLowerCase()] = c.mean; });

        const baseCentroid = {
          trust: meanBy.trust,
          clarity: meanBy.clarity,
          motivation: meanBy.motivation,
          roi_intent: meanBy["roi intent"] ?? meanBy.roi_intent
        };

        const segs = Array.isArray(bibleSegments) ? bibleSegments.slice(0) : [];

        if (orgKey === "salesforce") {
          return [{
            id: "A",
            label: "Single Cluster (early sample)",
            share: 1.0,
            n: decisionN,
            primary_pattern: "insufficient_sample",
            psych_description: "With limited Tier-3 volume, VeriTechIQ collapses segmentation into a single exploratory cluster to avoid false precision.",
            centroid: {
              trust: baseCentroid.trust,
              clarity: baseCentroid.clarity,
              motivation: baseCentroid.motivation,
              roi_intent: baseCentroid.roi_intent
            },
            quick_actions: [
              "Collect Tier-3: target +60 responses to begin stable segmentation.",
              "In the meantime, run 1–2 broad variants (clarity-first vs proof-first).",
              "Use Tier-2 open text to discover unknown objections."
            ]
          }];
        }

        // If bible has 0/1 segments, still show something coherent
        if (segs.length <= 1) {
          const only = segs[0] || { label: "Single Segment", share: 1.0, note: "" };
          return [{
            id: "A",
            label: only.label || "Single Segment",
            share: 1.0,
            n: decisionN,
            primary_pattern: "single_segment",
            psych_description: only.note || "A single coherent profile for this scope.",
            centroid: {
              trust: baseCentroid.trust,
              clarity: baseCentroid.clarity,
              motivation: baseCentroid.motivation,
              roi_intent: baseCentroid.roi_intent
            },
            quick_actions: actionPackForLabel(only.label)
          }];
        }

        // For others: map the bible segment shares directly
        const out = segs.map((s, idx) => {
          const share = (typeof s.share === "number") ? s.share : (1 / segs.length);
          const n = Math.max(1, Math.round(decisionN * share));
          const id = idx === 0 ? "A" : idx === 1 ? "B" : "C";

          // Slight centroid nudges so cards don't look copy/paste, while staying centered on org means
          const wiggle = (idx === 0 ? 0.4 : idx === 1 ? -0.4 : 0.0);
          const centroid = {
            trust: isFinite(baseCentroid.trust) ? clamp(baseCentroid.trust + wiggle, 1, 7) : baseCentroid.trust,
            clarity: isFinite(baseCentroid.clarity) ? clamp(baseCentroid.clarity + (idx === 0 ? 0.2 : -0.3), 1, 7) : baseCentroid.clarity,
            motivation: isFinite(baseCentroid.motivation) ? clamp(baseCentroid.motivation + (idx === 1 ? 0.3 : -0.1), 1, 7) : baseCentroid.motivation,
            roi_intent: isFinite(baseCentroid.roi_intent) ? clamp(baseCentroid.roi_intent + (idx === 0 ? 0.3 : -0.2), 1, 7) : baseCentroid.roi_intent
          };

          return {
            id,
            label: s.label || ("Segment " + id),
            share,
            n,
            primary_pattern: (s.label || "").toLowerCase().replace(/\s+/g, "_"),
            psych_description: s.note || "",
            centroid,
            quick_actions: actionPackForLabel(s.label)
          };
        });

        // Ensure n sums exactly to decisionN (demo polish)
        const sum = out.reduce((a, s) => a + (s.n || 0), 0);
        const diff = decisionN - sum;
        if (out.length && diff !== 0) out[0].n = Math.max(1, out[0].n + diff);

        return out;
      }

      function distRow(label, d) {
        const mean = d && isFinite(d.mean) ? fmt1(d.mean) : "—";
        const min = d && isFinite(d.min) ? fmt1(d.min) : "—";
        const max = d && isFinite(d.max) ? fmt1(d.max) : "—";

        return `
          <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3">
            <div class="text-xs font-semibold text-slate-100">${escapeHtml(label)}</div>
            <div class="mt-2 flex items-center justify-between text-[12px] text-slate-300">
              <span>μ <span class="font-semibold text-slate-100 tabular-nums">${escapeHtml(mean)}</span></span>
              <span class="text-slate-400">min <span class="tabular-nums">${escapeHtml(min)}</span> · max <span class="tabular-nums">${escapeHtml(max)}</span></span>
            </div>
          </div>
        `;
      }

      function scorePill(label, val) {
        const v = Number(val);
        const txt = isFinite(v) ? v.toFixed(1) : "—";
        const cls =
          !isFinite(v) ? "border-slate-700 text-slate-300"
          : v >= 5.6 ? "border-emerald-500/40 text-emerald-200"
          : v >= 4.7 ? "border-sky-500/40 text-sky-200"
          : "border-amber-500/40 text-amber-200";

        return `
          <div class="rounded-xl border ${cls} bg-slate-950/40 px-3 py-2">
            <div class="text-[10px] uppercase tracking-wide text-slate-400 font-semibold">${escapeHtml(label)}</div>
            <div class="mt-0.5 text-lg font-semibold tabular-nums">${escapeHtml(txt)}</div>
          </div>
        `;
      }

      function patternLabel(code) {
        if (!code) return "Pattern";
        return String(code).replace(/_/g, " ").replace(/\b\w/g, (m) => m.toUpperCase());
      }

      function segmentCard(seg, relBand) {
        const sharePct = fmtPct(seg.share);
        const band = bandColors[relBand] ? relBand : "gray";
        const b = bandColors[band];

        const actions = Array.isArray(seg.quick_actions) ? seg.quick_actions : [];
        const actionsHtml = actions.length
          ? `<ul class="mt-3 space-y-1.5 text-[12px] text-slate-300 list-disc list-inside">
              ${actions.map(a => `<li>${escapeHtml(a)}</li>`).join("")}
            </ul>`
          : `<p class="mt-3 text-[12px] text-slate-400">No recommended actions available yet.</p>`;

        return `
          <article class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <p class="text-[11px] uppercase tracking-wide text-slate-400 font-semibold">Segment ${escapeHtml(seg.id || "—")}</p>
                <h3 class="text-base font-semibold text-slate-100">${escapeHtml(seg.label || "Segment")}</h3>
                <p class="mt-1 text-sm text-slate-300">${escapeHtml(seg.psych_description || "")}</p>
              </div>

              <div class="text-right">
                <div class="text-xs text-slate-300"><span class="font-semibold text-slate-100 tabular-nums">${(seg.n || 0).toLocaleString()}</span> respondents</div>
                <div class="mt-1 inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-[11px] ${b.badge}">
                  <span class="h-2 w-2 rounded-full ${b.dot}"></span>
                  <span>${escapeHtml(sharePct)} of Tier-3 sample</span>
                </div>
                <div class="mt-2 inline-flex items-center gap-1.5 rounded-full border border-slate-700 bg-slate-950/40 px-2.5 py-0.5 text-[11px] text-slate-200">
                  <span class="h-2 w-2 rounded-full bg-sky-300"></span>
                  <span>${escapeHtml(patternLabel(seg.primary_pattern))}</span>
                </div>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-2">
              ${scorePill("Trust", seg.centroid && seg.centroid.trust)}
              ${scorePill("Clarity", seg.centroid && seg.centroid.clarity)}
              ${scorePill("Motivation", seg.centroid && seg.centroid.motivation)}
              ${scorePill("ROI-Intent", seg.centroid && seg.centroid.roi_intent)}
            </div>

            <div class="mt-4 rounded-xl border border-slate-800 bg-slate-950/30 p-3">
              <p class="text-[11px] uppercase tracking-wide text-slate-400 font-semibold">What to do next</p>
              ${actionsHtml}
            </div>
          </article>
        `;
      }

      function reliabilityBodyFor(decisionStatus, bandKey) {
        const s = String(decisionStatus || "").toLowerCase();
        const band = String(bandKey || "").toLowerCase();

        if (band === "green") {
          return "Signals are stable enough for planning conversations. Use segments to prioritize and design changes, then validate with controlled tests.";
        }
        if (band === "yellow" || band === "amber") {
          return "Patterns are forming. Use this to tailor copy and steer experiments, but treat lift claims as directional until reliability stabilizes.";
        }
        if (band === "gray") {
          return "Too few Tier-3 responses to trust segment boundaries. Treat this view as exploratory only — keep collecting Tier-3 before acting confidently.";
        }
        if (band === "red") {
          return "Signals are weak/unstable for segmentation. Collect more verified Tier-3 before using this for decision-making.";
        }

        // fallback on status words
        if (s.includes("decision")) return "Signals are stable enough for planning conversations. Validate with tests, then scale.";
        if (s.includes("emerging")) return "Use as hypothesis fuel while collecting more Tier-3.";
        if (s.includes("learning") || s.includes("directional")) return "Exploratory only — collect more Tier-3.";
        return "—";
      }

      // ─────────────────────────────────────────────────────────────
      // Render
      // ─────────────────────────────────────────────────────────────
      function render() {
        const data = getOrgData(activeOrg);
        if (!data) return;

        const orgLabel = data.org_label || activeOrg;
        const decision = data.decision || {};
        const psych = data.psychographics || {};
        const constructs = Array.isArray(psych.constructs) ? psych.constructs : [];
        const bibleSegments = Array.isArray(psych.segments) ? psych.segments : [];

        const band = String(decision.band || "gray").toLowerCase(); // green/yellow/gray/red
        const alpha = (typeof decision.alpha === "number") ? decision.alpha : null;
        const n = (typeof decision.n === "number") ? decision.n : null;
        const status = decision.status || (band === "green" ? "Decision-Ready" : band === "gray" ? "Learning Signal" : "Emerging Signal");

        // Scope
        scopeOrg.textContent = orgLabel;
        scopeCampaign.textContent = activeCampaign || "vip";

        // Reliability badge + meta
        const bandKey = (band === "yellow") ? "amber" : band;
        const b = bandColors[bandKey] || bandColors.gray;

        reliabilityBadge.className =
          "inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-[11px] font-medium uppercase tracking-wide " + b.badge;

        reliabilityBadge.innerHTML =
          `<span class="h-2 w-2 rounded-full ${b.dot}"></span><span>${escapeHtml(b.label)}</span>`;

        reliabilityBody.textContent = reliabilityBodyFor(status, bandKey);
        reliabilityMeta.textContent =
          "Cronbach’s α: " + (alpha != null ? fmt2(alpha) : "—") +
          " · Tier-3 n: " + (n != null ? Number(n).toLocaleString() : "—") +
          " · Algorithm: " + (bandKey === "green" ? "kmeans-lite (Tier-3 centroid split)" : bandKey === "amber" ? "kmeans-lite (Tier-3 centroid split)" : "fallback (median split)");

        // Respondents line (use Tier-3 n, not some separate number)
        nRespondents.textContent = (n != null ? n.toLocaleString() : "—") + " respondents";

        // Segments (derived from bible)
        const decisionN = (n != null ? n : 0);
        const segs = deriveSegmentsFromBible(activeOrg, decisionN, constructs, bibleSegments);

        if (!segs.length) {
          segmentsWrap.innerHTML = `
            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
              <p class="text-sm text-slate-300">No segments available yet for this scope.</p>
              <p class="mt-1 text-[12px] text-slate-400">Collect more Tier-3 responses to unlock clustering.</p>
            </div>
          `;
        } else {
          segmentsWrap.innerHTML = segs.map(s => segmentCard(s, bandKey)).join("");
        }

        // Distributions (derived from bible means)
        const d = deriveDistributions(constructs);
        distGrid.innerHTML = [
          distRow("Trust", d.trust),
          distRow("Clarity", d.clarity),
          distRow("Motivation", d.motivation),
          distRow("ROI-Intent", d.roi_intent),
        ].join("");

        // Keep URL in sync (for copy/paste links)
        setQueryParamSilently("org", activeOrg);
        setQueryParamSilently("campaign", activeCampaign || "vip");
      }

      // ─────────────────────────────────────────────────────────────
      // Events
      // ─────────────────────────────────────────────────────────────
      orgPills.forEach(function (pill) {
        pill.addEventListener("click", function () {
          activeOrg = (pill.dataset.org || "democo");
          applyOrgPillsUI();
          render();
        });
      });

      campaignButton.addEventListener("click", function () {
        activeCampaign = (campaignInput.value || "").trim() || "vip";
        render();
      });

      campaignInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          activeCampaign = (campaignInput.value || "").trim() || "vip";
          render();
        }
      });

      // Init
      campaignInput.value = qpCampaign || "vip";
      applyOrgPillsUI();
      render();
    })();
  </script>
</body>
</html>
